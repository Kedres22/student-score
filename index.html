<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Enhanced Viewport for Mobile Control -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Score Management System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css for Richer Animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --primary: #4f46e5; /* Indigo-600 */
            --primary-dark: #4338ca; /* Indigo-700 */
            --primary-light: #c7d2fe; /* Indigo-200 */
            --secondary: #10b981; /* Emerald-500 */
            --danger: #ef4444; /* Red-500 */
            --danger-dark: #dc2626; /* Red-600 */
            --warning: #f59e0b; /* Amber-500 */
            --warning-dark: #d97706; /* Amber-600 */
            --info: #3b82f6; /* Blue-500 */
            --info-dark: #2563eb; /* Blue-600 */
            --dark-bg: #111827; /* Gray-900 */
            --dark-card: #1f2937; /* Gray-800 */
            --dark-border: #374151; /* Gray-700 */
            --light-text: #f3f4f6; /* Gray-100 */
            --medium-text: #9ca3af; /* Gray-400 */
            --light-border: #e5e7eb; /* Gray-200 */
        }

        /* --- General & Typography --- */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Animations --- */
        @keyframes subtlePulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.95; } }
        @keyframes softFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes focusPulse { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }

        /* --- Dark Mode --- */
        .dark-mode { background-color: var(--dark-bg); color: var(--light-text); }
        .dark-mode .card, .dark-mode .stats-card { background-color: var(--dark-card); border-color: var(--dark-border); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); }
        .dark-mode .header-card { border-color: var(--dark-border); }
        .dark-mode th { background-color: var(--dark-card); border-bottom-color: var(--dark-border); color: var(--medium-text); }
        .dark-mode tbody tr { border-bottom-color: var(--dark-border); }
        .dark-mode input, .dark-mode select { background-color: var(--dark-border); border-color: #4b5563; color: var(--light-text); }
        .dark-mode input:disabled, .dark-mode select:disabled { background-color: #374151; opacity: 0.6; cursor: not-allowed; }
        .dark-mode input::placeholder, .dark-mode select option[value=""] { color: var(--medium-text); }
        .dark-mode input:focus:not(:disabled), .dark-mode select:focus:not(:disabled) { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); animation: focusPulse 1s infinite cubic-bezier(0.66, 0, 0, 1); }
        .dark-mode .info-box { background-color: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); }
        .dark-mode .info-box p { color: #93c5fd; }
        .dark-mode .switch .slider { background-color: #4b5563; }
        .dark-mode .table-container { border-color: var(--dark-border); }
        .dark-mode tbody tr:hover { background-color: #374151; }
        .dark-mode .badge-pass { background-color: #064e3b; color: #a7f3d0; }
        .dark-mode .badge-fail { background-color: #7f1d1d; color: #fecaca; }
        .dark-mode .subject-group:hover { background-color: rgba(165, 180, 252, 0.05); border-left-color: var(--primary-light); }
        .dark-mode .btn-ghost { color: var(--primary-light); border-color: var(--primary-light); }
        .dark-mode .btn-ghost:hover:not(:disabled) { background-color: rgba(165, 180, 252, 0.1); }
        .dark-mode ::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark-mode ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .dark-mode .sort-icon.text-indigo-600 { color: var(--primary-light); }

        /* --- Theme Switch --- */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- Toast Notifications --- */
        .toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 8px; color: white; z-index: 1050; opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); max-width: 90%; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); transform: translateX(110%); display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .toast.show { opacity: 1; transform: translateX(0); animation: softFloat 3s ease-in-out infinite 0.5s; }
        .toast-close { background: none; border: none; color: rgba(255,255,255,0.7); font-size: 1.3em; cursor: pointer; padding: 0 5px; line-height: 1; transition: color 0.2s; }
        .toast-close:hover { color: white; }

        /* --- Cards --- */
        .card { background-color: white; border-radius: 16px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.07); transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); border: 1px solid var(--light-border); overflow: hidden; }
        .card:hover { transform: translateY(-6px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1); }

        /* --- Buttons --- */
        .btn { transition: all 0.25s ease-out; transform: translateY(0); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); border-radius: 8px; padding: 12px 18px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; line-height: 1.2; border: none; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12); }
        .btn:active:not(:disabled) { transform: translateY(0px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #059669; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-dark); }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-warning:hover:not(:disabled) { background-color: var(--warning-dark); }
        .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover:not(:disabled) { background-color: var(--info-dark); }
        .btn-ghost { background-color: transparent; color: var(--primary); border: 1px solid var(--primary); box-shadow: none; }
        .btn-ghost:hover:not(:disabled) { background-color: rgba(79, 70, 229, 0.05); }
        .btn-icon { padding: 10px; }

        /* --- Form Elements (Includes Disabled Styles) --- */
        input, select { transition: all 0.3s ease; border: 1px solid #d1d5db; border-radius: 8px; padding: 12px 16px; width: 100%; font-size: 1rem; }
        input:disabled, select:disabled { background-color: #f3f4f6; cursor: not-allowed; opacity: 0.7; }
        input:focus:not(:disabled), select:focus:not(:disabled) { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); outline: none; animation: focusPulse 1s infinite cubic-bezier(0.66, 0, 0, 1); }
        label { font-weight: 500; margin-bottom: 8px; display: block; color: #374151; }
        .dark-mode label { color: var(--medium-text); }
        label.disabled-label { color: #9ca3af; }
        .input-error { border-color: var(--danger) !important; }
        .error-message { color: var(--danger); font-size: 0.8rem; margin-top: 4px; }
        fieldset { border: none; padding: 0; margin: 0; }
        legend { padding: 0; font-size: 1.125rem; line-height: 1.75rem; }

        /* --- Table --- */
        .table-container { overflow-x: auto; border: 1px solid var(--light-border); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        table { min-width: 100%; border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; padding: 14px 18px; text-align: left; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--light-border); white-space: nowrap; }
        td { padding: 16px 14px; font-size: 0.9rem; white-space: nowrap; border-bottom: 1px solid var(--light-border); vertical-align: middle;}
        tbody tr:last-child td { border-bottom: none; }
        tbody tr { transition: background-color 0.2s ease; }
        tbody tr:hover { background-color: #f3f4f6; }
        .animate-row-in { animation: fadeIn 0.5s ease forwards; }
        .animate-row-out { animation: fadeOut 0.3s ease forwards; }

        /* --- Status Badges --- */
        .badge { padding: 5px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .badge-pass { background-color: #d1fae5; color: #065f46; }
        .badge-fail { background-color: #fee2e2; color: #991b1b; }

        /* --- Subject Inputs --- */
        .subject-group { border-left: 3px solid transparent; padding-left: 12px; margin-bottom: 16px; transition: all 0.3s ease; }
        .subject-group:hover, .subject-group:focus-within { border-left-color: var(--primary); background-color: rgba(79, 70, 229, 0.03); }
        .form-section-disabled { opacity: 0.6; pointer-events: none; }
        .form-section-disabled legend { color: #9ca3af !important; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 1024px) {
            .lg-grid-cols-3 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
            .lg-col-span-1, .lg-col-span-2 { grid-column: span 1 / span 1; }
        }
        @media (max-width: 640px) {
            .container { padding-left: 1rem; padding-right: 1rem; }
            .card { border-radius: 0; margin-left: -1rem; margin-right: -1rem; box-shadow: none; border-left: none; border-right: none;}
            .header-card { border-radius: 12px; margin-left: 0; margin-right: 0; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08); border: 1px solid var(--light-border); }
            .mobile-stack { flex-direction: column; align-items: stretch; }
            .mobile-stack > * { margin-bottom: 12px; width: 100%; }
            .mobile-stack > *:last-child { margin-bottom: 0; }
            h1 { font-size: 1.5rem; } h2 { font-size: 1.125rem; } legend {font-size: 1rem;}
            .stats-grid { grid-template-columns: repeat(1, minmax(0, 1fr)); }
            .fab { bottom: 1.5rem; right: 1.5rem; width: 56px; height: 56px; }
            .toast { max-width: calc(100% - 2rem); left: 1rem; right: 1rem; top: 1rem; transform: translateY(-120%); }
            .toast.show { transform: translateY(0); }
            .action-buttons button { padding: 8px; margin-left: 4px; }
            .sm-hide-text span { display: none; }
            .sm-hide-text i { margin-right: 0; }
            th, td { padding: 12px 10px; font-size: 0.85rem; }
            th[data-column="name"], td:nth-child(1) { min-width: 110px; }
            th[data-column="educationLevel"], td:nth-child(2) { min-width: 100px; }
            th[data-column="total"], td:nth-child(3) { min-width: 60px; text-align: right;}
            th[data-column="average"], td:nth-child(4) { min-width: 70px; text-align: right;}
            th[data-column="status"], td:nth-child(5) { min-width: 75px; text-align: center;}
            th[data-column="rank"], td:nth-child(6) { min-width: 50px; text-align: center;}
            th:last-child, td:last-child { min-width: 80px; }
        }

        /* --- Loading Spinner --- */
        .loading-spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        .dark .loading-spinner { border-top-color: var(--light-text); border-color: rgba(243, 244, 246, 0.3); }

        /* --- FAB, Gradient, Scrollbar --- */
        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); transition: all 0.3s ease; z-index: 1000; animation: subtlePulse 2.5s infinite ease-in-out; border: none; }
        .fab:hover { transform: scale(1.1) translateY(-4px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); animation-play-state: paused; }
        .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 8px;}
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- Helper Classes --- */
        .hidden { display: none !important; }

        /* --- User Info Styles (New) --- */
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 16px; }
        .user-name { font-weight: 500; color: white; }
        .logout-btn { background: none; border: none; color: var(--primary-light); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: color 0.2s; }
        .logout-btn:hover { color: white; }

        /* Add these new styles after the existing styles */
        .hamburger-menu {
            display: none;
            cursor: pointer;
            padding: 0.5rem;
            z-index: 50;
        }

        .hamburger-menu span {
            display: block;
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .grade-filter {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
            padding: 0.25rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .grade-filter button {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 0.75rem;
        }

        .grade-filter button.active {
            background: white;
            color: var(--primary);
        }

        .grade-filter button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .hamburger-menu {
                display: block;
            }

            .header-content {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: var(--primary);
                padding: 0.5rem;
                z-index: 40;
            }

            .header-content.active {
                display: block;
            }

            .grade-filter {
                flex-direction: row;
                overflow-x: auto;
                padding: 0.25rem;
                margin: 0.25rem 0;
            }

            .grade-filter button {
                flex: 0 0 auto;
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }

            /* Hide scrollbar but keep functionality */
            .grade-filter::-webkit-scrollbar {
                display: none;
            }
            .grade-filter {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
    </style>
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300 font-sans antialiased">
    <!-- Toast Notification Placeholder -->
    <div id="toast" class="toast hidden"></div>

    <!-- Floating Action Button -->
    <button id="scrollTopBtn" class="fab bg-indigo-600 text-white hidden animate__animated animate__faster" aria-label="Scroll to top">
        <i class="fas fa-arrow-up text-xl"></i>
    </button>

    <!-- Main Container -->
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header (Modified to include Hamburger Menu) -->
        <header class="gradient-bg text-white rounded-xl p-6 mb-8 shadow-lg header-card animate__animated animate__fadeInDown">
            <div class="flex justify-between items-center">
                <div class="hamburger-menu" id="hamburgerMenu">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold">Student Score Manager</h1>
            </div>
            
            <div class="header-content" id="headerContent">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <p class="text-indigo-100 mt-1 text-sm sm:text-base"></p>
                    </div>
                    <div class="flex items-center gap-4 flex-wrap">
                        <!-- User Info -->
                        <div class="user-info">
                            <div class="user-avatar" id="user-avatar">U</div>
                            <div class="user-name" id="user-name">User</div>
                            <button class="logout-btn" id="logout-btn">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </button>
                        </div>
                        <!-- Theme Toggle -->
                        <div class="flex items-center space-x-3 bg-white/10 backdrop-blur-sm rounded-full px-3 py-1.5">
                            <i class="fas fa-sun text-yellow-300 text-sm"></i>
                            <label class="switch">
                                <input type="checkbox" id="themeToggle" aria-label="Toggle dark mode">
                                <span class="slider"></span>
                            </label>
                            <i class="fas fa-moon text-indigo-200 text-sm"></i>
                        </div>
                    </div>
                </div>

                <!-- Grade Filter -->
                <div class="grade-filter mt-2">
                    <button data-grade="9" class="grade-btn">G9</button>
                    <button data-grade="10" class="grade-btn">G10</button>
                    <button data-grade="11-natural" class="grade-btn">G11-N</button>
                    <button data-grade="11-social" class="grade-btn">G11-S</button>
                    <button data-grade="12-natural" class="grade-btn">G12-N</button>
                    <button data-grade="12-social" class="grade-btn">G12-S</button>
                </div>
            </div>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8 lg-grid-cols-3">
            <!-- Add/Edit Student Form Section -->
            <div class="lg:col-span-1 lg-col-span-1 card p-6 animate__animated animate__fadeInUp" style="margin-top: 4rem;">
                <h2 class="text-xl font-semibold mb-5 text-gray-800 dark:text-gray-200 flex items-center transition-colors duration-300">
                    <i id="formIcon" class="fas fa-user-plus mr-3 text-indigo-600 dark:text-indigo-300 transition-all duration-300"></i>
                    <span id="formTitle">Add Student Record</span>
                </h2>
                <form id="studentForm" class="space-y-5" novalidate>
                    <fieldset>
                        <legend class="text-lg font-medium mb-3 text-gray-700 dark:text-gray-300">1. Select Level & Stream</legend>
                        <div>
                            <label for="educationLevel" class="text-gray-700 dark:text-gray-300">Education Level</label>
                            <select id="educationLevel" required class="dark:bg-gray-700 dark:border-gray-600">
                                <option value="" disabled selected>Select Level...</option>
                                <option value="Elementary">Elementary</option>
                                <option value="Secondary">Secondary</option>
                                <option value="Preparatory">Preparatory</option>
                            </select>
                            <p class="error-message hidden" id="levelError">Education level is required.</p>
                        </div>
                        <div id="preparatoryStreamContainer" class="mt-4 hidden animate__animated">
                            <label for="preparatoryStream" class="text-gray-700 dark:text-gray-300">Preparatory Stream</label>
                            <select id="preparatoryStream" class="dark:bg-gray-700 dark:border-gray-600">
                                <option value="" disabled selected>Select Stream...</option>
                                <option value="Natural">Natural Science</option>
                                <option value="Social">Social Science</option>
                            </select>
                            <p class="error-message hidden" id="streamError">Stream is required for Preparatory level.</p>
                        </div>
                    </fieldset>
                    <fieldset id="studentDetailsSection" class="form-section-disabled">
                        <legend class="text-lg font-medium mb-3 text-gray-700 dark:text-gray-300">2. Student Details</legend>
                        <div>
                            <label for="studentName" class="text-gray-700 dark:text-gray-300">Student Full Name</label>
                            <input type="text" id="studentName" placeholder="e.g., Abebe Kebede" required disabled class="dark:bg-gray-700 dark:border-gray-600">
                            <p class="error-message hidden" id="nameError">Student name is required.</p>
                        </div>
                        <div>
                            <label for="genderSelect" class="text-gray-700 dark:text-gray-300">Gender</label>
                            <select id="genderSelect" required disabled class="dark:bg-gray-700 dark:border-gray-600">
                                <option value="" disabled selected>Select Gender...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                            <p class="error-message hidden" id="genderError">Gender is required.</p>
                        </div>
                        <div id="gradeContainer">
                            <label for="gradeSelect" class="text-gray-700 dark:text-gray-300">Grade</label>
                            <select id="gradeSelect" required disabled class="dark:bg-gray-700 dark:border-gray-600">
                                <option value="" disabled selected>Select Grade...</option>
                            </select>
                            <p class="error-message hidden" id="gradeError">Grade is required.</p>
                        </div>
                        <div>
                            <label for="sectionSelect" class="text-gray-700 dark:text-gray-300">Section</label>
                            <select id="sectionSelect" required disabled class="dark:bg-gray-700 dark:border-gray-600">
                                <option value="" disabled selected>Select Section...</option>
                            </select>
                            <p class="error-message hidden" id="sectionError">Section is required.</p>
                        </div>
                        <div>
                            <label for="ageInput" class="text-gray-700 dark:text-gray-300">Age</label>
                            <input type="number" id="ageInput" placeholder="e.g., 15" min="5" max="30" required disabled class="dark:bg-gray-700 dark:border-gray-600">
                            <p class="error-message hidden" id="ageError">Valid age (5-30) is required.</p>
                        </div>
                    </fieldset>
                    <fieldset id="subjectsSection" class="form-section-disabled">
                        <legend class="text-lg font-medium mb-3 text-gray-700 dark:text-gray-300">3. Subject Marks</legend>
                        <div id="subjectsContainer" class="space-y-3 pt-2">
                            <div class="info-box bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800/50">
                                <p class="text-blue-700 dark:text-blue-300 text-sm flex items-center">
                                    <i class="fas fa-info-circle mr-2 flex-shrink-0"></i>
                                    <span>Select Level/Stream first to enter marks.</span>
                                </p>
                            </div>
                        </div>
                        <p class="error-message hidden" id="marksError">Enter valid marks (0-100) for all subjects.</p>
                    </fieldset>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 pt-4 mobile-stack">
                        <button type="submit" id="saveRecordBtn" class="btn btn-primary flex-1" disabled>
                            <span class="loading-spinner hidden mr-2"></span>
                            <i class="fas fa-save mr-2"></i>
                            <span id="saveButtonText">Save Record</span>
                        </button>
                        <button type="button" id="clearFormBtn" class="btn btn-ghost flex-1 sm:flex-none">
                            <i class="fas fa-eraser mr-2"></i> Clear Form
                        </button>
                        <button type="button" id="cancelEditBtn" class="btn btn-ghost hidden flex-1 sm:flex-none">
                            <i class="fas fa-times mr-2"></i> Cancel Edit
                        </button>
                    </div>
                </form>
            </div>
            <!-- Student Records & Statistics Section -->
            <div class="lg:col-span-2 lg-col-span-2 space-y-6 lg:space-y-8">
                <div class="card p-6 animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5 gap-4">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 flex items-center flex-shrink-0">
                            <i class="fas fa-list-ul mr-3 text-indigo-600 dark:text-indigo-300"></i>
                            Student Records
                        </h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                            <div class="relative w-full sm:w-48">
                                <input type="search" id="searchInput" placeholder="Search by name..." class="pl-10 pr-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 w-full text-sm focus:ring-2 focus:ring-indigo-400">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                            <div class="flex space-x-2">
                                <button id="exportCSVBtn" class="btn btn-info btn-icon sm:btn sm-hide-text" aria-label="Export to CSV">
                                    <i class="fas fa-file-csv text-lg sm:text-base"></i>
                                    <span class="hidden sm:inline">Export</span>
                                </button>
                                <a href="card.html" target="_blank" class="btn btn-secondary">
                                    <i class="fas fa-print mr-2"></i> Print Cards
                                </a>
                                <button id="clearAllBtn" class="btn btn-danger btn-icon sm:btn sm-hide-text" aria-label="Clear all records">
                                    <i class="fas fa-trash-alt text-lg sm:text-base"></i>
                                    <span class="hidden sm:inline">Clear All</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full">
                            <thead class="select-none">
                                <tr>
                                    <th class="cursor-pointer sortable hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-column="name">
                                        <div class="flex items-center justify-between">
                                            <span>Name</span>
                                            <i class="fas fa-sort text-gray-400 sort-icon ml-1 opacity-50"></i>
                                        </div>
                                    </th>
                                    <th class="cursor-pointer sortable hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-column="educationLevel">
                                        <div class="flex items-center justify-between">
                                            <span>Level/Stream</span>
                                            <i class="fas fa-sort text-gray-400 sort-icon ml-1 opacity-50"></i>
                                        </div>
                                    </th>
                                    <th class="cursor-pointer sortable hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-right" data-column="total">
                                        <div class="flex items-center justify-end">
                                            <span>Totalăți: Total
                                            <i class="fas fa-sort text-gray-400 sort-icon ml-1 opacity-50"></i>
                                        </div>
                                    </th>
                                    <th class="cursor-pointer sortable hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-right" data-column="average">
                                        <div class="flex items-center justify-end">
                                            <span>Avg (%)</span>
                                            <i class="fas fa-sort text-gray-400 sort-icon ml-1 opacity-50"></i>
                                        </div>
                                    </th>
                                    <th class="cursor-pointer sortable hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-column="status">
                                        <div class="flex items-center justify-center">
                                            <span>Status</span>
                                            <i class="fas fa-sort text-gray-400 sort-icon ml-1 opacity-50"></i>
                                        </div>
                                    </th>
                                    <th class="cursor-pointer sortable hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-center" data-column="rank">
                                        <div class="flex items-center justify-center">
                                            <span>Rank</span>
                                            <i class="fas fa-sort text-gray-400 sort-icon ml-1 opacity-50"></i>
                                        </div>
                                    </th>
                                    <th class="text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr id="loadingStateRow" class="hidden"><td colspan="7" class="text-center py-10 px-6 text-gray-500 dark:text-gray-400"><div class="flex flex-col items-center justify-center animate__animated animate__fadeIn"><i class="fas fa-circle-notch fa-spin text-3xl text-indigo-500 dark:text-indigo-400 mb-3"></i><p class="font-medium">Loading records...</p></div></td></tr>
                                <tr id="emptyStateRow" class="hidden"><td colspan="7" class="text-center py-10 px-6 text-gray-500 dark:text-gray-400"><div class="flex flex-col items-center justify-center animate__animated animate__fadeIn"><i class="fas fa-folder-open text-4xl text-gray-300 dark:text-gray-600 mb-3"></i><p class="font-medium">No student records found.</p><p class="text-sm" id="emptyStateSubtext">Add a student using the form.</p></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card p-6 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                    <h2 class="text-xl font-semibold mb-5 text-gray-800 dark:text-gray-200 flex items-center">
                        <i class="fas fa-chart-pie mr-3 text-indigo-600 dark:text-indigo-300"></i>
                        Class Statistics
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 stats-grid">
                        <div class="stats-card bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-200 dark:border-blue-800/50 transform transition-all duration-300 hover:scale-105 hover:shadow-md">
                            <h3 class="text-sm font-medium text-blue-600 dark:text-blue-300 mb-1 flex items-center"><i class="fas fa-users mr-2"></i> Total Students</h3>
                            <p id="totalStudentsStat" class="text-2xl font-bold text-blue-800 dark:text-blue-200 transition-all duration-300">0</p>
                        </div>
                        <div class="stats-card bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-lg border border-indigo-200 dark:border-indigo-800/50 transform transition-all duration-300 hover:scale-105 hover:shadow-md">
                            <h3 class="text-sm font-medium text-indigo-600 dark:text-indigo-300 mb-1 flex items-center"><i class="fas fa-percentage mr-2"></i> Class Average</h3>
                            <p id="classAverageStat" class="text-2xl font-bold text-indigo-800 dark:text-indigo-200 transition-all duration-300">0%</p>
                        </div>
                        <div class="stats-card bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-200 dark:border-green-800/50 transform transition-all duration-300 hover:scale-105 hover:shadow-md">
                            <h3 class="text-sm font-medium text-green-600 dark:text-green-300 mb-1 flex items-center"><i class="fas fa-user-check mr-2"></i> Pass Rate</h3>
                            <p id="passRateStat" class="text-2xl font-bold text-green-800 dark:text-green-200 transition-all duration-300">0%</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (New) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>
        // --- Firebase Configuration (New) ---
        const firebaseConfig = {
            apiKey: "AIzaSyC4o4hjlawM90AzNfVt5Vc5KdfI-GMioSU",
            authDomain: "signup-aed74.firebaseapp.com",
            projectId: "signup-aed74",
            storageBucket: "signup-aed74.appspot.com",
            messagingSenderId: "771640526986",
            appId: "1:771640526986:web:7f0f18c26c0a5c24824573"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // DOM Elements for User Info (New)
        const logoutBtn = document.getElementById('logout-btn');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');

        // Check Authentication State (New)
        auth.onAuthStateChanged((user) => {
            if (!user || !user.emailVerified) {
                // Redirect to sign-in page if not authenticated or email not verified
                window.location.href = 'signin.html';
            } else {
                // Update user info in header
                userName.textContent = user.displayName || user.email;
                if (user.displayName) {
                    userAvatar.textContent = user.displayName.charAt(0).toUpperCase();
                } else if (user.email) {
                    userAvatar.textContent = user.email.charAt(0).toUpperCase();
                }
            }
        });

        // Logout Handler (New)
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'signin.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                showToast('Failed to log out. Please try again.', 'red');
            });
        });

        // --- Existing JavaScript Code ---
        const SUBJECTS = {
            "Elementary": ['Siltigna', 'Amharic', 'English', 'Maths', 'Citizenship', 'Biology', 'Chemistry', 'Physics', 'History', 'Geography', 'Economics', 'Agriculture', 'HPE'],
            "Secondary": ['Siltigna', 'Amharic', 'English', 'Maths', 'Citizenship', 'Biology', 'Chemistry', 'Physics', 'History', 'Geography', 'Economics', 'Agriculture', 'HPE'],
            "Preparatory": {
                "Natural": ['English', 'Maths', 'Biology', 'Chemistry', 'Physics', 'ICT', 'Agriculture'],
                "Social": ['English', 'Maths', 'Geography', 'History', 'Economics', 'ICT']
            }
        };
        let students = []; // Stores { name, gender, grade, section, age, educationLevel, preparatoryStream?, subjects, total, average, status, rank }
        let currentSortColumn = null;
        let sortDirection = 1; // 1 for asc, -1 for desc
        let editingIndex = null; // Index of the student being edited IN THE `students` ARRAY
        let originalStudent = null; // Store original data before editing

        // --- DOM Element References ---
        const themeToggle = document.getElementById('themeToggle');
        const studentForm = document.getElementById('studentForm');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const saveButtonText = document.getElementById('saveButtonText');
        const saveSpinner = saveRecordBtn.querySelector('.loading-spinner');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const searchInput = document.getElementById('searchInput');
        const exportCSVBtn = document.getElementById('exportCSVBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const studentTableBody = document.getElementById('studentTableBody');
        const emptyStateRow = document.getElementById('emptyStateRow');
        const loadingStateRow = document.getElementById('loadingStateRow');
        const emptyStateSubtext = document.getElementById('emptyStateSubtext');
        const classAverageStatEl = document.getElementById('classAverageStat');
        const passRateStatEl = document.getElementById('passRateStat');
        const totalStudentsStatEl = document.getElementById('totalStudentsStat');
        const toastEl = document.getElementById('toast');
        const scrollTopBtn = document.getElementById('scrollTopBtn');
        const formTitle = document.getElementById('formTitle');
        const formIcon = document.getElementById('formIcon');
        // Form Field Refs
        const educationLevelSelect = document.getElementById('educationLevel');
        const preparatoryStreamContainer = document.getElementById('preparatoryStreamContainer');
        const preparatoryStreamSelect = document.getElementById('preparatoryStream');
        const studentDetailsSection = document.getElementById('studentDetailsSection');
        const studentNameInput = document.getElementById('studentName');
        const genderSelect = document.getElementById('genderSelect');
        const gradeContainer = document.getElementById('gradeContainer');
        const gradeSelect = document.getElementById('gradeSelect');
        const sectionSelect = document.getElementById('sectionSelect');
        const ageInput = document.getElementById('ageInput');
        const subjectsSection = document.getElementById('subjectsSection');
        const subjectsContainer = document.getElementById('subjectsContainer');
        // Error message elements
        const levelError = document.getElementById('levelError');
        const streamError = document.getElementById('streamError');
        const nameError = document.getElementById('nameError');
        const genderError = document.getElementById('genderError');
        const gradeError = document.getElementById('gradeError');
        const sectionError = document.getElementById('sectionError');
        const ageError = document.getElementById('ageError');
        const marksError = document.getElementById('marksError');

        // --- Debounce Utility ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadThemePreference();
            populateSectionOptions(); // Populate static section dropdown
            setupEventListeners();
            showLoadingState(); // Show loading indicator initially
            loadStudentsFromLocalStorage(() => {
                 // Offer sample data only if needed after loading attempt
                 if (students.length === 0 && localStorage.getItem('sampleDataOffered') !== 'true') {
                     setTimeout(() => initializeSampleData(), 300);
                     localStorage.setItem('sampleDataOffered', 'true');
                 }
            });
            window.addEventListener('scroll', toggleScrollTopButton);
            scrollTopBtn.addEventListener('click', scrollToTop);
            checkFormCompletion(); // Initial check for save button state
        });

        // --- Populate Static Options ---
        function populateSectionOptions() {
             const fragment = document.createDocumentFragment();
             for (let i = 65; i <= 90; i++) { // ASCII A-Z
                 const letter = String.fromCharCode(i);
                 const option = document.createElement('option');
                 option.value = letter;
                 option.textContent = letter;
                 fragment.appendChild(option);
             }
             sectionSelect.appendChild(fragment);
        }

        // --- Local Storage & Data Handling ---
        function showLoadingState() {
             loadingStateRow.classList.remove('hidden');
             emptyStateRow.classList.add('hidden');
             studentTableBody.querySelectorAll("tr:not(#emptyStateRow):not(#loadingStateRow)").forEach(row => row.remove());
        }

        function loadStudentsFromLocalStorage(callback) {
             // Simulate async loading
             setTimeout(() => {
                try {
                    students = JSON.parse(localStorage.getItem('students')) || [];
                    // **Add validation for new fields**
                    if (!Array.isArray(students)) students = [];
                    students = students.filter(s =>
                        typeof s === 'object' && s !== null &&
                        s.name && s.gender && s.grade && s.section && s.age && // Check new required fields
                        s.educationLevel && Array.isArray(s.subjects)
                    );
                    
                    // Sort students alphabetically by name
                    students.sort((a, b) => a.name.localeCompare(b.name));
                    
                } catch (e) {
                    console.error("Error loading or parsing student data from localStorage:", e);
                    students = []; // Reset on error
                    localStorage.removeItem('students'); // Clear potentially corrupted data
                } finally {
                    renderStudents();
                    updateStatistics();
                    loadingStateRow.classList.add('hidden'); // Hide loading state regardless of outcome
                    if (callback) callback(); // Execute callback after loading attempt
                }
             }, 500); // Simulate loading delay
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('students', JSON.stringify(students));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                showToast("Could not save data. Storage might be full.", "red");
            }
        }

        // --- Theme Management ---
        function loadThemePreference() {
            if (localStorage.getItem('darkMode') === 'true' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
                themeToggle.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.checked = false;
            }
        }

        function toggleTheme() {
            const isDarkMode = themeToggle.checked;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);
            document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            themeToggle.addEventListener('change', toggleTheme);
            educationLevelSelect.addEventListener('change', handleEducationLevelChange);
            preparatoryStreamSelect.addEventListener('change', handleStreamChange);
            studentForm.addEventListener('submit', handleFormSubmit);
            clearFormBtn.addEventListener('click', () => clearForm(true));
            cancelEditBtn.addEventListener('click', cancelEdit);
            searchInput.addEventListener('input', debounce(searchStudents, 300));
            exportCSVBtn.addEventListener('click', exportToCSV);
            clearAllBtn.addEventListener('click', confirmClearAllStudents);
            setupSortingListeners();
            // Listen for input/change on the form to dynamically enable/disable save button
            studentForm.addEventListener('input', checkFormCompletion); // Catches typing, number changes
            studentForm.addEventListener('change', checkFormCompletion); // Catches select changes
        }
        function setupSortingListeners() {
             document.querySelectorAll('.sortable').forEach(header => {
                header.removeEventListener('click', handleSortClick); // Prevent duplicates
                header.addEventListener('click', handleSortClick);
            });
        }
        function handleSortClick(event) {
             const header = event.currentTarget;
             const column = header.getAttribute('data-column');
             sortStudents(column);
             updateSortIcons(header);
        }

        // --- UI Rendering & Updates ---
        function renderStudents(filteredStudents = null) {
            const studentsToRender = filteredStudents || students;
            const fragment = document.createDocumentFragment(); // Use fragment for performance
            studentTableBody.querySelectorAll("tr:not(#emptyStateRow):not(#loadingStateRow)").forEach(row => row.remove());

            if (studentsToRender.length === 0 && loadingStateRow.classList.contains('hidden')) {
                emptyStateRow.classList.remove('hidden');
                emptyStateSubtext.textContent = searchInput.value ? 'No matches found. Try another search.' : 'No student records yet. Use the form to add one.';
            } else if (studentsToRender.length > 0) {
                emptyStateRow.classList.add('hidden');
                studentsToRender.forEach((student, index) => {
                    const originalIndex = students.findIndex(s => s === student); // Find index in original array
                    if (originalIndex !== -1) {
                       const row = createStudentRow(student, originalIndex, index);
                       fragment.appendChild(row);
                    }
                });
                 studentTableBody.appendChild(fragment); // Append all rows at once
            }
             updateStatistics(); // Always update stats after render
        }

        // Modified to display only required columns in the browser
        function createStudentRow(student, originalIndex, animationIndex) {
            const row = document.createElement('tr');
            row.className = 'dark:text-gray-200 text-gray-700 animate-row-in';
            row.style.animationDelay = `${Math.min(animationIndex * 0.06, 0.6)}s`;

            // Determine stream display (only if preparatory)
            const levelDisplay = student.educationLevel === 'Preparatory'
                ? `Prep (${student.preparatoryStream || 'N/A'})` // Abbreviate for space
                : student.educationLevel;

            row.innerHTML = `
                <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">${student.name}</td>
                <td class="px-4 py-3 text-sm">${levelDisplay}</td>
                <td class="px-4 py-3 text-right">${student.total.toFixed(1)}</td>
                <td class="px-4 py-3 text-right">${student.average.toFixed(1)}%</td>
                <td class="px-4 py-3 text-center">
                    <span class="badge ${student.status === 'Pass' ? 'badge-pass' : 'badge-fail'}">
                       <i class="fas ${student.status === 'Pass' ? 'fa-check-circle' : 'fa-times-circle'} text-xs mr-1"></i>
                       ${student.status}
                    </span>
                </td>
                <td class="px-4 py-3 font-semibold text-center">${student.rank}</td>
                <td class="px-4 py-3 text-right action-buttons whitespace-nowrap"> <!-- Ensure buttons don't wrap -->
                    <button onclick="editStudent(${originalIndex})" class="text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 p-2 transition-all duration-200 rounded-md hover:bg-indigo-100 dark:hover:bg-indigo-900/50 active:scale-95" aria-label="Edit ${student.name}">
                        <i class="fas fa-pencil-alt fa-fw"></i>
                    </button>
                    <button onclick="confirmDeleteStudent(${originalIndex})" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-2 transition-all duration-200 rounded-md hover:bg-red-100 dark:hover:bg-red-900/50 ml-2 active:scale-95" aria-label="Delete ${student.name}">
                        <i class="fas fa-trash-alt fa-fw"></i>
                    </button>
                </td>
            `;
             row.addEventListener('mouseenter', () => row.classList.add('bg-gray-50', 'dark:bg-gray-700/50'));
             row.addEventListener('mouseleave', () => row.classList.remove('bg-gray-50', 'dark:bg-gray-700/50'));
            return row;
        }

        function updateSortIcons(activeHeader) {
            document.querySelectorAll('.sortable .sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort text-gray-400 sort-icon ml-1 opacity-50'; // Reset all icons
            });
            if (activeHeader) {
                const icon = activeHeader.querySelector('.sort-icon');
                 const iconClass = sortDirection === 1 ? 'fa-sort-up' : 'fa-sort-down';
                 // Make active icon visible and colored
                 icon.className = `fas ${iconClass} text-indigo-600 dark:text-indigo-300 sort-icon ml-1 opacity-100`;
            }
        }
        function updateStatistics() {
            const studentCount = students.length;
            totalStudentsStatEl.textContent = studentCount;

            if (studentCount === 0) {
                classAverageStatEl.textContent = '0%';
                passRateStatEl.textContent = '0%';
                return;
            }

            const totalAverageSum = students.reduce((sum, student) => sum + student.average, 0);
            const classAvg = totalAverageSum / studentCount;
            classAverageStatEl.textContent = `${classAvg.toFixed(1)}%`;

            const passCount = students.filter(student => student.status === 'Pass').length;
            const passRate = (passCount / studentCount) * 100;
            passRateStatEl.textContent = `${passRate.toFixed(1)}%`;

            // Animate stat updates
            [totalStudentsStatEl, classAverageStatEl, passRateStatEl].forEach(el => {
                el.classList.add('animate__animated', 'animate__pulse', 'animate__faster');
                setTimeout(() => el.classList.remove('animate__animated', 'animate__pulse', 'animate__faster'), 500);
            });
        }

        // --- Form Handling & Validation ---

        // Function to enable/disable form sections and inputs
        function setSectionDisabled(sectionElement, isDisabled) {
            sectionElement.classList.toggle('form-section-disabled', isDisabled);
            sectionElement.querySelectorAll('input, select').forEach(el => {
                el.disabled = isDisabled;
                // Also update label appearance
                const label = sectionElement.querySelector(`label[for="${el.id}"]`);
                if (label) {
                    label.classList.toggle('disabled-label', isDisabled);
                }
            });
        }

        // Populate Grade dropdown based on level
        function populateGradeOptions(level) {
            gradeSelect.innerHTML = '<option value="" disabled selected>Select Grade...</option>'; // Reset
            let grades = [];
            switch (level) {
                case 'Elementary': grades = [5, 6, 7, 8]; break;
                case 'Secondary': grades = [9, 10]; break;
                case 'Preparatory': grades = [11, 12]; break;
            }
            const fragment = document.createDocumentFragment();
            grades.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = `Grade ${g}`;
                fragment.appendChild(option);
            });
            gradeSelect.appendChild(fragment);
        }

        // Main handler for level change - Controls flow
        function handleEducationLevelChange() {
            const level = educationLevelSelect.value;
            const isPreparatory = level === 'Preparatory';

            clearValidationErrors(['level', 'stream', 'grade', 'marks']); // Clear relevant errors

            // 1. Handle Preparatory Stream Visibility
            if (isPreparatory) {
                 preparatoryStreamContainer.classList.remove('hidden', 'animate__fadeOut');
                 preparatoryStreamContainer.classList.add('animate__fadeIn');
                 preparatoryStreamSelect.value = '';
                 preparatoryStreamSelect.required = true;
            } else {
                 preparatoryStreamContainer.classList.add('animate__fadeOut');
                 setTimeout(() => preparatoryStreamContainer.classList.add('hidden'), 300); // Hide after fadeOut
                 preparatoryStreamSelect.required = false;
                 preparatoryStreamSelect.value = ''; // Ensure value is cleared
            }

            // 2. Enable/Disable Student Details Section & Populate Grades
            if (level) {
                 setSectionDisabled(studentDetailsSection, false); // Enable student details
                 populateGradeOptions(level); // Populate grades based on new level
                 gradeSelect.value = ""; // Reset grade selection after populating
                 // Reset other details fields too
                 studentNameInput.value = '';
                 genderSelect.value = '';
                 sectionSelect.value = '';
                 ageInput.value = '';
            } else {
                 setSectionDisabled(studentDetailsSection, true); // Disable details if level cleared
                 gradeSelect.innerHTML = '<option value="" disabled selected>Select Grade...</option>'; // Clear grades
            }

            // 3. Enable/Disable Subjects Section & Populate Subjects
            const streamSelected = !isPreparatory || (isPreparatory && !!preparatoryStreamSelect.value);
            if (level && streamSelected) {
                setSectionDisabled(subjectsSection, false); // Enable subjects
                populateSubjects(level, preparatoryStreamSelect.value || null);
            } else {
                setSectionDisabled(subjectsSection, true); // Disable subjects
                if (level && isPreparatory && !streamSelected) {
                    displaySubjectInfo("Select Stream to enter marks.");
                } else if (!level) {
                    displaySubjectInfo("Select Level first.");
                } else {
                     displaySubjectInfo("Select Level/Stream to see subjects."); // Default
                }
            }

            checkFormCompletion(); // Update save button state after all changes
        }

        // Handles stream change *only for preparatory*
        function handleStreamChange() {
            const level = educationLevelSelect.value;
            const stream = preparatoryStreamSelect.value;
            clearValidationErrors(['stream', 'marks']); // Clear stream and mark errors

            if (level === 'Preparatory') {
                if (stream) {
                    setSectionDisabled(subjectsSection, false); // Enable subjects
                    populateSubjects(level, stream);
                } else {
                    setSectionDisabled(subjectsSection, true); // Disable subjects if stream unselected
                    displaySubjectInfo("Select Stream to enter marks.");
                }
            } // Ignore if not preparatory level
            checkFormCompletion(); // Update save button state
        }

        function displaySubjectInfo(message) {
             subjectsContainer.innerHTML = `
                <div class="info-box bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800/50 animate__animated animate__fadeIn">
                    <p class="text-blue-700 dark:text-blue-300 text-sm flex items-center">
                        <i class="fas fa-info-circle mr-2 flex-shrink-0"></i>
                        <span>${message}</span>
                    </p>
                </div>`;
        }
        function populateSubjects(level, stream = null) {
            subjectsContainer.innerHTML = ''; // Clear previous
            let subjectsList = [];
            if (stream && level === 'Preparatory') {
                subjectsList = SUBJECTS[level]?.[stream] || [];
            } else if (level && level !== 'Preparatory') { // Populate only if level is selected and not preparatory (stream handled above)
                subjectsList = SUBJECTS[level] || [];
            }

            if (subjectsList.length === 0 && (level || stream)) {
                displaySubjectInfo("No subjects defined for this selection.");
                return;
            } else if (subjectsList.length === 0) {
                 // If no subjects expected (e.g., level not selected yet), keep the default info message
                 displaySubjectInfo("Select Level/Stream to see subjects.");
                 return;
            }

            const fragment = document.createDocumentFragment();
            subjectsList.forEach((subject, index) => {
                const subjectGroup = document.createElement('div');
                // Use a unique ID for the label/input connection
                const inputId = `mark-${subject.replace(/\s+/g, '-')}-${index}`;
                subjectGroup.className = 'subject-group animate__animated animate__fadeInUp';
                subjectGroup.style.animationDelay = `${index * 0.05}s`;
                subjectGroup.innerHTML = `
                    <label for="${inputId}" class="block text-gray-700 dark:text-gray-300 text-sm font-medium mb-1.5">${subject}</label>
                    <input type="number" id="${inputId}" placeholder="Mark (0-100)" min="0" max="100" step="0.1"
                           class="subject-mark w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-sm"
                           data-subject="${subject}" required>
                    <p class="error-message hidden subject-error">Invalid mark.</p>
                `;
                fragment.appendChild(subjectGroup);
            });
            subjectsContainer.appendChild(fragment);
        }

        function handleFormSubmit(event) {
            event.preventDefault();
             if (!validateForm()) {
                 showToast('Please correct the errors in the form.', 'red');
                 const firstError = studentForm.querySelector('.input-error');
                 if (firstError) firstError.focus();
                 return;
             }
            setLoadingState(true);
            // Simulate network delay
            setTimeout(() => {
                 saveStudent();
                 setLoadingState(false);
            }, 300);
        }

        // Modified Validation
        function validateForm() {
             clearValidationErrors();
             let isValid = true;
             const errorMessages = []; // Collect error messages

             // --- Check Flow Dependencies ---
             const level = educationLevelSelect.value;
             if (!level) {
                 levelError.classList.remove('hidden');
                 educationLevelSelect.classList.add('input-error');
                 isValid = false;
                 errorMessages.push("Education Level");
                 // Stop validation early if base level is missing
                 return isValid;
             }

             const isPreparatory = level === 'Preparatory';
             const stream = preparatoryStreamSelect.value;
             if (isPreparatory && !stream) {
                 streamError.classList.remove('hidden');
                 preparatoryStreamSelect.classList.add('input-error');
                 isValid = false;
                 errorMessages.push("Preparatory Stream");
             }

             // --- Validate Student Details (Only if section is enabled) ---
             if (!studentDetailsSection.classList.contains('form-section-disabled')) {
                 if (!studentNameInput.value.trim()) { nameError.classList.remove('hidden'); studentNameInput.classList.add('input-error'); isValid = false; errorMessages.push("Student Name"); }
                 if (!genderSelect.value) { genderError.classList.remove('hidden'); genderSelect.classList.add('input-error'); isValid = false; errorMessages.push("Gender"); }
                 if (!gradeSelect.value) { gradeError.classList.remove('hidden'); gradeSelect.classList.add('input-error'); isValid = false; errorMessages.push("Grade"); }
                 if (!sectionSelect.value) { sectionError.classList.remove('hidden'); sectionSelect.classList.add('input-error'); isValid = false; errorMessages.push("Section"); }
                 const age = parseInt(ageInput.value, 10);
                 if (!ageInput.value || isNaN(age) || age < 5 || age > 30) { ageError.classList.remove('hidden'); ageInput.classList.add('input-error'); isValid = false; errorMessages.push("Valid Age (5-30)"); }
             } else if (level) {
                 // If level is selected but details are still disabled (shouldn't normally happen), it's an issue
                 // console.warn("Validation issue: Details section disabled while level is selected.");
                 // isValid = false; // Or handle as appropriate
             }

             // --- Validate Subject Marks (Only if section is enabled) ---
             let marksValid = true; // Assume valid initially for this section
             if (!subjectsSection.classList.contains('form-section-disabled')) {
                 const markInputs = subjectsContainer.querySelectorAll('.subject-mark');
                 if (markInputs.length > 0) {
                     markInputs.forEach(input => {
                         const markValue = input.value.trim();
                         const mark = parseFloat(markValue);
                         const subjectError = input.parentElement.querySelector('.subject-error');
                         if (markValue === '' || isNaN(mark) || mark < 0 || mark > 100) {
                             input.classList.add('input-error');
                             if (subjectError) subjectError.classList.remove('hidden');
                             marksValid = false;
                             isValid = false;
                         }
                     });
                     if (!marksValid) {
                         marksError.textContent = "Enter valid marks (0-100) for all subjects.";
                         marksError.classList.remove('hidden');
                         errorMessages.push("Subject Marks");
                     }
                 } else {
                     // If subjects section is enabled but no inputs exist (valid config?)
                     marksError.textContent = "No subjects loaded to enter marks.";
                     marksError.classList.remove('hidden');
                      // Depending on requirements, this might be an error
                     // isValid = false; errorMessages.push("Missing Subjects");
                 }
             } else if (level && (!isPreparatory || stream)) {
                  // If subjects *should* be enabled but aren't (shouldn't happen with correct flow)
                  // console.warn("Validation issue: Subjects section disabled unexpectedly.");
                  // isValid = false; // Or handle as appropriate
             }

             // Optional: Log collected errors
             // if (!isValid) console.log("Validation failed for fields:", errorMessages.join(', '));

             return isValid;
        }

        // Modified Clear Errors
         function clearValidationErrors(fieldsToClear = ['level', 'stream', 'name', 'gender', 'grade', 'section', 'age', 'marks']) {
             const errorMap = {
                 level: { input: educationLevelSelect, error: levelError },
                 stream: { input: preparatoryStreamSelect, error: streamError },
                 name: { input: studentNameInput, error: nameError },
                 gender: { input: genderSelect, error: genderError },
                 grade: { input: gradeSelect, error: gradeError },
                 section: { input: sectionSelect, error: sectionError },
                 age: { input: ageInput, error: ageError },
                 marks: { input: null, error: marksError }
             };

             fieldsToClear.forEach(field => {
                 if (errorMap[field]) {
                     if (errorMap[field].input) {
                         errorMap[field].input.classList.remove('input-error');
                     }
                     if (errorMap[field].error) {
                         errorMap[field].error.classList.add('hidden');
                     }
                 }
             });

             if (fieldsToClear.includes('marks')) {
                 subjectsContainer.querySelectorAll('.subject-mark').forEach(input => {
                     input.classList.remove('input-error');
                     const subjectError = input.parentElement.querySelector('.subject-error');
                     if (subjectError) subjectError.classList.add('hidden');
                 });
             }
        }

         function setLoadingState(isLoading) {
             saveRecordBtn.disabled = isLoading;
             if (isLoading) {
                 saveSpinner.classList.remove('hidden');
                 saveButtonText.textContent = editingIndex !== null ? 'Updating...' : 'Saving...';
                 saveRecordBtn.classList.add('opacity-75');
                 // Disable other buttons during save
                 clearFormBtn.disabled = true;
                 cancelEditBtn.disabled = true;
             } else {
                 saveSpinner.classList.add('hidden');
                 // Text reset happens in resetEditState or saveStudent
                 saveRecordBtn.classList.remove('opacity-75');
                 // Re-enable other buttons
                 clearFormBtn.disabled = false;
                 cancelEditBtn.disabled = false;
                 // Re-evaluate save button disabled state based on form content
                 checkFormCompletion();
             }
         }

        // Modified Clear Form
        function clearForm(resetEdit = true) {
            studentForm.reset(); // Resets native form elements to default state
            clearValidationErrors(); // Clear any validation messages/styles

            // Manually reset selects to their placeholder state if reset() doesn't do it
            educationLevelSelect.value = "";
            preparatoryStreamSelect.value = "";
            genderSelect.value = "";
            gradeSelect.innerHTML = '<option value="" disabled selected>Select Grade...</option>';
            sectionSelect.value = "";

            // Disable dependent sections and reset subject area
            setSectionDisabled(studentDetailsSection, true);
            setSectionDisabled(subjectsSection, true);
            preparatoryStreamContainer.classList.add('hidden');
            displaySubjectInfo("Select Level first."); // Reset subject info box

            if (resetEdit) {
                 resetEditState(); // Resets edit mode UI if needed
            } else {
                // If just clearing without resetting edit state (e.g., after save),
                // ensure save button is disabled as the form is now empty.
                 saveRecordBtn.disabled = true;
            }

            educationLevelSelect.focus(); // Focus the first field
        }

        // Check if all *enabled* and *required* fields are filled
        function checkFormCompletion() {
             let isComplete = true;

             // Check Level
             if (!educationLevelSelect.value) { isComplete = false; }

             // Check Stream if Preparatory
             const isPreparatory = educationLevelSelect.value === 'Preparatory';
             if (isPreparatory && !preparatoryStreamSelect.value) { isComplete = false; }

             // Check Details Section if Enabled
             if (!studentDetailsSection.classList.contains('form-section-disabled')) {
                 if (!studentNameInput.value.trim()) { isComplete = false; }
                 if (!genderSelect.value) { isComplete = false; }
                 if (!gradeSelect.value) { isComplete = false; }
                 if (!sectionSelect.value) { isComplete = false; }
                 const age = parseInt(ageInput.value, 10);
                 if (!ageInput.value || isNaN(age) || age < 5 || age > 30) { isComplete = false; }
             } else if (educationLevelSelect.value) {
                 // If level selected but details still disabled (error in flow?), form is incomplete
                 isComplete = false;
             }

             // Check Marks Section if Enabled
             if (!subjectsSection.classList.contains('form-section-disabled')) {
                 const markInputs = subjectsContainer.querySelectorAll('.subject-mark');
                 if (markInputs.length === 0) {
                      // If subjects *should* be there but aren't, it's incomplete (unless 0 subjects is valid)
                      // isComplete = false; // Uncomment if having subjects is always required when section enabled
                 } else {
                     markInputs.forEach(input => {
                         const markValue = input.value.trim();
                         const mark = parseFloat(markValue);
                         if (markValue === '' || isNaN(mark) || mark < 0 || mark > 100) {
                             isComplete = false;
                         }
                     });
                 }
             } else if (educationLevelSelect.value && (!isPreparatory || preparatoryStreamSelect.value)) {
                 // If subjects *should* be enabled but aren't, form is incomplete
                 isComplete = false;
             }

             // Enable/disable save button based on completion status (and not currently saving)
             saveRecordBtn.disabled = !isComplete || saveRecordBtn.querySelector('.loading-spinner:not(.hidden)');
        }

        // --- Student Data Operations ---
        function getSubjectsFromForm() {
            const subjects = [];
            subjectsContainer.querySelectorAll('.subject-mark').forEach(input => {
                const name = input.getAttribute('data-subject');
                const value = input.value.trim();
                // Only include if a valid mark is entered for this subject
                if (name && value !== '') {
                     const mark = parseFloat(value);
                     if (!isNaN(mark) && mark >= 0 && mark <= 100) {
                        subjects.push({ name, mark: parseFloat(mark.toFixed(1)) });
                     }
                 }
            });
            return subjects;
        }
        function calculateMetrics(subjects) {
            if (!Array.isArray(subjects) || subjects.length === 0) {
                return { total: 0, average: 0, status: 'Fail' };
            }
            let validMarksCount = 0;
            const total = subjects.reduce((sum, subject) => {
                if (subject.mark !== null && subject.mark !== undefined && !isNaN(subject.mark)) {
                    validMarksCount++;
                    return sum + subject.mark;
                }
                return sum;
            }, 0);

            if (validMarksCount === 0) {
                return { total: 0, average: 0, status: 'Fail' };
            }
            const average = total / validMarksCount;
            const status = average >= 50 ? 'Pass' : 'Fail';
            return { total, average, status };
        }
        function calculateRanks() {
            if (students.length === 0) return;
            const studentsToSort = students.map((s, index) => ({ average: s.average, originalIndex: index }));
             studentsToSort.sort((a, b) => b.average - a.average);
             let rank = 1;
             studentsToSort.forEach((sortedStudent, i) => {
                 if (i > 0 && studentsToSort[i - 1].average > sortedStudent.average) {
                     rank = i + 1;
                 }
                 students[sortedStudent.originalIndex].rank = rank;
             });
        }

        // Modified Save Student
        function saveStudent() {
             // Gather all data from form
             const level = educationLevelSelect.value;
             const stream = level === 'Preparatory' ? preparatoryStreamSelect.value : null;
             const name = studentNameInput.value.trim();
             const gender = genderSelect.value;
             const grade = gradeSelect.value;
             const section = sectionSelect.value;
             const age = parseInt(ageInput.value, 10);
             const subjects = getSubjectsFromForm();
             const { total, average, status } = calculateMetrics(subjects);

             // Create the student data object
             const studentData = {
                 educationLevel: level, preparatoryStream: stream,
                 name, gender, grade, section, age, subjects,
                 total, average, status, rank: 0 // Rank calculated later
             };

             let message = '';
             let isUpdate = editingIndex !== null;

             if (isUpdate) {
                 // Update existing student data
                 students[editingIndex] = studentData;
                 message = `Record for "${name}" updated successfully!`;
             } else {
                 // Add new student data
                 students.push(studentData);
                 message = `Record for "${name}" added successfully!`;
             }

             calculateRanks(); // Always recalculate ranks after changes
             saveToLocalStorage(); // Save the updated students array
             renderStudents(); // Update the displayed table
             showToast(message, 'green'); // Show success message

             if (isUpdate) {
                 resetEditState(); // Reset the form from edit mode
             }
             // Clear form fields and reset disabled states for the next entry
             clearForm(false); // Pass false to prevent resetting edit state again
        }

        // Modified Edit Student
        function editStudent(index) {
             // Prevent re-clicking edit on the same student or while editing another
             if (editingIndex !== null && editingIndex !== index) {
                 showToast("Finish editing the current student first.", "yellow");
                 return;
             }
             if (editingIndex === index) {
                 studentNameInput.focus(); // Just focus if already editing this one
                 return;
             }

            const student = students[index];
            if (!student) {
                console.error("Student not found at index for editing:", index);
                showToast("Could not find student record to edit.", "red");
                return;
            }

            originalStudent = JSON.parse(JSON.stringify(student)); // Deep copy
            editingIndex = index;

            // --- Populate Form Accurately ---
            // 1. Set Level - this triggers downstream enabling/populating
            educationLevelSelect.value = student.educationLevel;
            handleEducationLevelChange(); // CRITICAL: Run this first

            // 2. Set Stream (if applicable) - AFTER level change might have shown the select
            if (student.educationLevel === 'Preparatory' && student.preparatoryStream) {
                preparatoryStreamSelect.value = student.preparatoryStream;
                handleStreamChange(); // CRITICAL: Run this to populate correct subjects for prep stream
            }

            // 3. Set Student Details (Sections should now be enabled correctly by handlers above)
            studentNameInput.value = student.name;
            genderSelect.value = student.gender;
            // Set Grade AFTER options are populated by handleEducationLevelChange
            gradeSelect.value = student.grade;
            sectionSelect.value = student.section;
            ageInput.value = student.age;

            // 4. Set Marks - Use timeout to ensure subject inputs are rendered
            setTimeout(() => {
                 // Clear existing marks before setting new ones, just in case
                 subjectsContainer.querySelectorAll('.subject-mark').forEach(input => input.value = '');
                 // Set marks from the student data
                 student.subjects.forEach(subject => {
                    const input = subjectsContainer.querySelector(`.subject-mark[data-subject="${subject.name}"]`);
                    if (input) {
                        input.value = subject.mark;
                        // Optional highlight
                        input.classList.add('bg-indigo-50', 'dark:bg-indigo-900/30', 'transition-colors', 'duration-500');
                        setTimeout(() => input.classList.remove('bg-indigo-50', 'dark:bg-indigo-900/30'), 1500);
                    } else {
                        console.warn(`Input not found for subject: ${subject.name} during edit.`);
                    }
                });
                 checkFormCompletion(); // Enable save button if form is now valid
            }, 150); // Adjust delay if needed

            // --- Update Form UI for Edit Mode ---
            formTitle.textContent = 'Edit Student Record';
            formIcon.className = 'fas fa-edit mr-3 text-yellow-600 dark:text-yellow-400 transition-all duration-300';
            saveButtonText.textContent = 'Update Record';
            saveRecordBtn.classList.replace('btn-primary', 'btn-warning');
            cancelEditBtn.classList.remove('hidden');
            clearFormBtn.classList.add('hidden');

            studentForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            showToast(`Now editing: ${student.name}`, 'blue');
        }

        function cancelEdit() {
             if (editingIndex === null) return; // Not in edit mode

             // Restore original data if needed (optional, only if you modified array during edit)
             // students[editingIndex] = originalStudent; // Example if needed

             resetEditState(); // Reset UI elements
             clearForm(false); // Clear form fields without triggering edit state reset again
             showToast('Edit cancelled.', 'gray');
        }

        function resetEditState() {
             editingIndex = null;
             originalStudent = null;
             // Reset form appearance
             formTitle.textContent = 'Add Student Record';
             formIcon.className = 'fas fa-user-plus mr-3 text-indigo-600 dark:text-indigo-300 transition-all duration-300';
             saveButtonText.textContent = 'Save Record';
             saveRecordBtn.classList.replace('btn-warning', 'btn-primary'); // Button color back
             cancelEditBtn.classList.add('hidden'); // Hide cancel button
             clearFormBtn.classList.remove('hidden'); // Show clear button
             clearValidationErrors(); // Clear any potential leftover errors

             // CRITICAL: Reset the form sections based on the *current* state of the Level select
             // This ensures disabled states are correct after cancelling.
             handleEducationLevelChange();

             // Save button should be disabled after reset/clear
             saveRecordBtn.disabled = true;
        }

        function confirmDeleteStudent(index) {
            const student = students[index];
            if (!student) return;
            if (confirm(`Are you sure you want to delete the record for "${student.name}"? This action cannot be undone.`)) {
                 deleteStudent(index);
            }
        }
        function deleteStudent(index) {
            const studentToDelete = students[index];
            if (!studentToDelete) return;

            // Find the corresponding row visually
            const rows = Array.from(studentTableBody.querySelectorAll("tr:not(#emptyStateRow):not(#loadingStateRow)"));
            let rowToDelete = null;
            // Try to find based on content (more robust than index if filtered/sorted)
            for (let row of rows) {
                 // Example: Check if the first cell (Name) matches
                 const nameCell = row.querySelector('td:first-child');
                 if (nameCell && nameCell.textContent === studentToDelete.name) {
                     // Add more checks if names aren't unique (e.g., check level too)
                     rowToDelete = row;
                     break;
                 }
            }
            // Fallback to index if not found by content (less reliable)
            if (!rowToDelete && rows[index]) {
                 // This assumes visual index matches original index, which might be wrong!
                 // console.warn("Could not find row by content, falling back to index for animation.");
                 // rowToDelete = rows[index]; // Use with caution
            }

             if (rowToDelete) {
                 rowToDelete.classList.remove('animate-row-in');
                 rowToDelete.classList.add('animate-row-out');
                 rowToDelete.addEventListener('animationend', () => {
                     // Check again before deleting data, in case of race conditions
                     if (students[index] === studentToDelete) {
                         performDeletion(index);
                     } else {
                         // If the data has shifted (e.g., another delete happened), re-render needed
                         console.warn("Data mismatch after delete animation, re-rendering.");
                         renderStudents(); // Force re-render to sync UI
                     }
                 }, { once: true });
             } else {
                 // If row not found visually, delete data directly and re-render
                 performDeletion(index);
             }
        }
        function performDeletion(index) {
            if (index < 0 || index >= students.length) return; // Bounds check

            const deletedStudentName = students[index].name; // Get name for toast message

            students.splice(index, 1); // Remove the student data
            calculateRanks(); // Ranks might change
            saveToLocalStorage();
            renderStudents(); // Re-render the table
            updateStatistics();
            showToast(`Record for "${deletedStudentName}" deleted.`, 'green');

            // Adjust editingIndex if necessary
            if (editingIndex === index) {
                // If we were editing the deleted student, reset everything
                resetEditState();
                clearForm(false);
            } else if (editingIndex > index) {
                // If we deleted a student *before* the one being edited, shift index down
                editingIndex--;
            }
        }

        function searchStudents() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (searchTerm === '') {
                renderStudents(); // Show all if search is cleared
                return;
            }
            // Consider searching more fields if needed
            const filtered = students.filter(student =>
                student.name.toLowerCase().includes(searchTerm) ||
                student.educationLevel.toLowerCase().includes(searchTerm) // Example: search level too
            );
             renderStudents(filtered); // Render only filtered students
        }
        function sortStudents(column) {
            if (!column) return;

            if (currentSortColumn === column) {
                sortDirection *= -1; // Toggle direction
            } else {
                currentSortColumn = column;
                sortDirection = 1; // Default ascending
            }

            // Create a copy to sort without modifying original array order directly (optional)
            // const sortedStudents = [...students];

            students.sort((a, b) => {
                 let valA = a[column];
                 let valB = b[column];

                 // Handle special cases like Level/Stream combined display
                 if (column === 'educationLevel') {
                     valA = a.educationLevel + (a.preparatoryStream || '');
                     valB = b.educationLevel + (b.preparatoryStream || '');
                 }

                 // Consistent type handling for comparison
                 if (typeof valA === 'string') valA = valA.toLowerCase();
                 if (typeof valB === 'string') valB = valB.toLowerCase();
                 // Handle null/undefined consistently during sort
                 if (valA === null || valA === undefined) valA = sortDirection === 1 ? Infinity : -Infinity;
                 if (valB === null || valB === undefined) valB = sortDirection === 1 ? Infinity : -Infinity;


                 if (valA < valB) return -1 * sortDirection;
                 if (valA > valB) return 1 * sortDirection;
                 // Secondary sort by name if primary values are equal (optional)
                 if (a.name.toLowerCase() < b.name.toLowerCase()) return -1;
                 if (a.name.toLowerCase() > b.name.toLowerCase()) return 1;
                 return 0;
             });

            renderStudents(); // Re-render table with the sorted `students` array
        }

        function confirmClearAllStudents() {
             if (students.length === 0) {
                showToast('No records to clear.', 'blue');
                return;
             }
             const confirmation = prompt('DANGER! This action will permanently delete ALL student records.\nType "DELETE ALL" to confirm:');
             if (confirmation === "DELETE ALL") {
                 clearAllStudents();
             } else if (confirmation !== null) {
                 showToast('Clear all operation cancelled.', 'gray');
             }
        }
        function clearAllStudents() {
            const rows = studentTableBody.querySelectorAll("tr:not(#emptyStateRow):not(#loadingStateRow)");
            rows.forEach((row, index) => {
                 row.style.animationDelay = `${index * 0.03}s`;
                 row.classList.remove('animate-row-in');
                 row.classList.add('animate__animated', 'animate__fadeOut');
            });

             // Wait for animations
             setTimeout(() => {
                students = [];
                saveToLocalStorage();
                renderStudents(); // Show empty state
                updateStatistics();
                resetEditState(); // Reset form completely
                clearForm(false); // Clear fields after reset
                showToast('All student records cleared.', 'green');
             }, rows.length * 30 + 300);
        }

        // Modified Export to CSV
        function exportToCSV() {
            if (students.length === 0) {
                showToast('No student records to export.', 'yellow');
                return;
            }
            calculateRanks(); // Ensure ranks are current

            // Define headers in the SPECIFIED order
            const headers = [
                'Education Level', 'Stream', 'Student Name', 'Gender', 'Grade', 'Section', 'Age',
            ];
            const calculatedHeaders = ['Total Score', 'Average (%)', 'Status', 'Rank'];

            // Dynamically get all unique subject names across all students
            const allSubjectNames = [...new Set(students.flatMap(s => s.subjects.map(sub => sub.name)))].sort();

            // Combine all headers in the final order
            const fullHeaders = [...headers, ...allSubjectNames, ...calculatedHeaders];

            // Function to safely quote CSV fields
            const quoteField = (field) => `"${String(field == null ? '' : field).replace(/"/g, '""')}"`;

            let csvContent = fullHeaders.map(quoteField).join(',') + '\n'; // Add headers row

            // Add data rows
            students.forEach(student => {
                const row = [
                    student.educationLevel,
                    student.preparatoryStream || '', // Stream or empty
                    student.name,
                    student.gender,
                    student.grade,
                    student.section,
                    student.age,
                ];

                 // Add subject marks in the correct column order
                 const subjectMarksMap = new Map(student.subjects.map(s => [s.name, s.mark.toFixed(1)]));
                 allSubjectNames.forEach(subName => {
                     row.push(subjectMarksMap.get(subName) || ''); // Add mark or empty string
                 });

                 // Add calculated fields
                 row.push(
                     student.total.toFixed(1),
                     student.average.toFixed(1),
                     student.status,
                     student.rank
                 );

                csvContent += row.map(quoteField).join(',') + '\n'; // Add the complete data row
            });

            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `student_records_detailed_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Clean up
                showToast('Detailed CSV exported!', 'green');
            } else {
                 showToast('CSV export not supported by your browser.', 'red');
            }
        }

        // --- Utilities ---
        function showToast(message, type = 'info') {
            toastEl.innerHTML = `
                <span class="flex-grow">${message}</span>
                <button class="toast-close" onclick="this.parentElement.classList.remove('show')">×</button>
            `;
            const colors = { green: 'bg-green-600', red: 'bg-red-600', blue: 'bg-blue-600', yellow: 'bg-yellow-500', gray: 'bg-gray-600'};
            toastEl.className = 'toast'; // Reset classes first
            toastEl.classList.add(colors[type] || 'bg-gray-600', 'show');

            clearTimeout(toastEl.timeoutId);
            toastEl.timeoutId = setTimeout(() => {
                 toastEl.classList.remove('show');
            }, 4000);
        }
        function toggleScrollTopButton() {
             if (window.pageYOffset > 300) {
                 if (scrollTopBtn.classList.contains('hidden')) {
                     scrollTopBtn.classList.remove('hidden');
                     scrollTopBtn.classList.add('animate__fadeInUp');
                     scrollTopBtn.classList.remove('animate__fadeOutDown');
                 }
             } else {
                 if (!scrollTopBtn.classList.contains('hidden')) {
                     scrollTopBtn.classList.add('animate__fadeOutDown');
                     scrollTopBtn.classList.remove('animate__fadeInUp');
                     setTimeout(() => scrollTopBtn.classList.add('hidden'), 300); // Hide after animation
                 }
             }
        }
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            scrollTopBtn.classList.add('scale-110');
            setTimeout(() => scrollTopBtn.classList.remove('scale-110'), 200);
        }

        // Modified Sample Data
        function initializeSampleData() {
            if (localStorage.getItem('sampleDataOffered') === 'true') return; // Don't prompt again if already offered

            if (confirm('No student data found. Would you like to load some sample data to get started?')) {
                showLoadingState(); // Show loading indicator
                setTimeout(() => { // Simulate loading process
                    students = [
                         {
                            educationLevel: 'Secondary', preparatoryStream: null, name: 'Bereket Tadesse', gender: 'Male', grade: '10', section: 'A', age: 16,
                            subjects: [ { name: 'Maths', mark: 85 }, { name: 'English', mark: 78 }, { name: 'Biology', mark: 92 }, { name: 'Physics', mark: 75 }, { name: 'Chemistry', mark: 81 }, { name: 'Amharic', mark: 88 } ],
                        },
                        {
                            educationLevel: 'Preparatory', preparatoryStream: 'Natural', name: 'Hana Girma', gender: 'Female', grade: '12', section: 'C', age: 18,
                            subjects: [ { name: 'Maths', mark: 72 }, { name: 'Chemistry', mark: 65 }, { name: 'Physics', mark: 80 }, { name: 'English', mark: 88 }, { name: 'Biology', mark: 77 }, { name: 'ICT', mark: 90} ],
                        },
                        {
                            educationLevel: 'Preparatory', preparatoryStream: 'Social', name: 'Yonas Alemayehu', gender: 'Male', grade: '11', section: 'B', age: 17,
                            subjects: [ { name: 'Geography', mark: 45 }, { name: 'History', mark: 52 }, { name: 'Economics', mark: 38 }, { name: 'English', mark: 60 }, { name: 'Maths', mark: 49 }, { name: 'ICT', mark: 55} ],
                        },
                         {
                            educationLevel: 'Elementary', preparatoryStream: null, name: 'Fatima Yusuf', gender: 'Female', grade: '8', section: 'D', age: 14,
                            subjects: [ { name: 'Amharic', mark: 95 }, { name: 'English', mark: 88 }, { name: 'Maths', mark: 91 }, { name: 'Citizenship', mark: 85 }, { name: 'Biology', mark: 90 }, { name: 'Physics', mark: 82 } ],
                        }
                    ];
                    // Crucial: Recalculate metrics and ranks for the loaded sample data
                    students.forEach(s => {
                        const {total, average, status} = calculateMetrics(s.subjects);
                        s.total = total;
                        s.average = average;
                        s.status = status;
                    });
                    calculateRanks();
                    saveToLocalStorage(); // Save the sample data
                    renderStudents(); // Display the data
                    updateStatistics(); // Update stats card
                    loadingStateRow.classList.add('hidden'); // Hide loading indicator
                    showToast('Sample data loaded!', 'green');
                }, 800); // Simulate delay
            } else {
                // If user declines, hide loading and show empty state
                 loadingStateRow.classList.add('hidden');
                 renderStudents();
            }
             localStorage.setItem('sampleDataOffered', 'true'); // Record that the offer was made
        }

        // Make debounce global if needed (usually not necessary with module pattern/event listeners)
        // window.debounce = debounce;

        // Add these new functions after the existing JavaScript code
        let currentGradeFilter = localStorage.getItem('currentGradeFilter') || null;

        // Hamburger Menu Toggle
        document.getElementById('hamburgerMenu').addEventListener('click', function() {
            const headerContent = document.getElementById('headerContent');
            headerContent.classList.toggle('active');
            this.classList.toggle('active');
        });

        // Grade Filter Buttons
        document.querySelectorAll('.grade-btn').forEach(button => {
            button.addEventListener('click', function() {
                const grade = this.dataset.grade;
                setGradeFilter(grade);
            });
        });

        function setGradeFilter(grade) {
            // Remove active class from all buttons
            document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to selected button
            const selectedBtn = document.querySelector(`[data-grade="${grade}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }

            // Save current grade filter
            currentGradeFilter = grade;
            localStorage.setItem('currentGradeFilter', grade);

            // Update form based on grade
            updateFormForGrade(grade);
            
            // Filter students table
            filterStudentsByGrade(grade);
        }

        function updateFormForGrade(grade) {
            const [gradeLevel, stream] = grade.split('-');
            
            // Set education level
            if (gradeLevel === '9' || gradeLevel === '10') {
                educationLevelSelect.value = 'Secondary';
            } else {
                educationLevelSelect.value = 'Preparatory';
            }
            
            // Trigger level change to enable form
            handleEducationLevelChange();

            // Set grade
            gradeSelect.value = gradeLevel;

            // Set stream if applicable
            if (stream) {
                preparatoryStreamSelect.value = stream.charAt(0).toUpperCase() + stream.slice(1);
                handleStreamChange();
            }

            // Enable student details section
            setSectionDisabled(studentDetailsSection, false);
        }

        function filterStudentsByGrade(grade) {
            const [gradeLevel, stream] = grade.split('-');
            
            const filteredStudents = students.filter(student => {
                if (gradeLevel === '9' || gradeLevel === '10') {
                    return student.educationLevel === 'Secondary' && student.grade === gradeLevel;
                } else {
                    return student.educationLevel === 'Preparatory' && 
                           student.grade === gradeLevel && 
                           student.preparatoryStream === (stream ? stream.charAt(0).toUpperCase() + stream.slice(1) : null);
                }
            });

            renderStudents(filteredStudents);
        }

        // Modify the existing saveStudent function
        const originalSaveStudent = saveStudent;
        saveStudent = function() {
            originalSaveStudent();
            
            // After saving, update the form for the current grade filter
            if (currentGradeFilter) {
                updateFormForGrade(currentGradeFilter);
            }
        };

        // Initialize grade filter on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (currentGradeFilter) {
                setGradeFilter(currentGradeFilter);
            }
        });

        // Modify the existing clearForm function
        const originalClearForm = clearForm;
        clearForm = function(resetEdit = true) {
            originalClearForm(resetEdit);
            
            // After clearing, update the form for the current grade filter
            if (currentGradeFilter) {
                updateFormForGrade(currentGradeFilter);
            }
        };
    </script>
</body>
</html>